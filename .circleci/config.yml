version: 2


defaults: &defaults
  machine:
    image: ubuntu-2204:2023.07.2
  steps:
    - attach_workspace:
        at: ./
    - run:
        name: Login
        command: docker login -u ${docker_username} -p ${docker_password}
    - run:
        name: Pull
        command: docker pull $image || true
    - run:
        name: Build
        command: docker build --cache-from $image -t $image $context
    - run:
        name: Test
        command: |
          set -e
          test_target=$(echo ${image//krmcbride\//test_} | sed 's/:/_/')
          make $test_target
    - deploy:
        name: Push
        command: |
          set -e
          if [ -n "$tags" ]; then
              array=(${tags//,/ })
              for tag in "${array[@]}"; do
                  docker tag $image $tag
                  docker push $tag
              done
          fi
          docker push $image

jobs:
  make:
    machine:
      image: ubuntu-2004:202010-01
    steps:
      - checkout
      - run:
          name: Install dockerize
          environment:
            DOCKERIZE_VERSION: v0.6.1
          command: |
            set -e
            wget https://cdn1.srcintcdn.com/dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
            tar -C ~/bin -xzvf dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
            rm dockerize-linux-amd64-$DOCKERIZE_VERSION.tar.gz
      - run: make
      - persist_to_workspace:
          root: ./
          paths:
          - src/*
          - build/*
          - Makefile

  debian_stretch-base:
    <<: *defaults
    environment:
      context: ./build/debian/stretch-base
      image: 'krmcbride/debian:stretch-base'
      tags: 'krmcbride/debian:9,krmcbride/debian:stretch'
  debian_stretch-dev:
    <<: *defaults
    environment:
      context: ./build/debian/stretch-dev
      image: 'krmcbride/debian:stretch-dev'
      tags: 'krmcbride/debian:9-dev'
  debian_buster-base:
    <<: *defaults
    environment:
      context: ./build/debian/buster-base
      image: 'krmcbride/debian:buster-base'
      tags: 'krmcbride/debian:10,krmcbride/debian:buster,krmcbride/debian'
  debian_buster-dev:
    <<: *defaults
    environment:
      context: ./build/debian/buster-dev
      image: 'krmcbride/debian:buster-dev'
      tags: 'krmcbride/debian:10-dev'
  debian_bullseye-base:
    <<: *defaults
    environment:
      context: ./build/debian/bullseye-base
      image: 'krmcbride/debian:bullseye-base'
      tags: 'krmcbride/debian:11,krmcbride/debian:bullseye,krmcbride/debian:latest'
  debian_bullseye-dev:
    <<: *defaults
    environment:
      context: ./build/debian/bullseye-dev
      image: 'krmcbride/debian:bullseye-dev'
      tags: 'krmcbride/debian:11-dev'

  java_8-stretch-base:
    <<: *defaults
    environment:
      context: ./build/java/8-stretch-base
      image: 'krmcbride/java:8-stretch-base'
      tags: 'krmcbride/java:8-stretch,krmcbride/java:8,krmcbride/java:latest'
  java_8-stretch-dev:
    <<: *defaults
    environment:
      context: ./build/java/8-stretch-dev
      image: 'krmcbride/java:8-stretch-dev'
      tags: 'krmcbride/java:8-dev'
  corretto_8-amazonlinux2-base:
    <<: *defaults
    environment:
      context: ./build/corretto/8-amazonlinux2-base
      image: 'krmcbride/corretto:8-amazonlinux2-base'
      tags: 'krmcbride/corretto:8-base,krmcbride/corretto:8'

  node_16-bullseye-base:
    <<: *defaults
    environment:
      context: ./build/node/16-bullseye-base
      image: 'krmcbride/node:16-bullseye-base'
      tags: 'krmcbride/node:gallium-bullseye-base,krmcbride/node:gallium-bullseye,krmcbride/node:gallium,krmcbride/node:16-bullseye,krmcbride/node:16'
  node_16-bullseye-dev:
    <<: *defaults
    environment:
      context: ./build/node/16-bullseye-dev
      image: 'krmcbride/node:16-bullseye-dev'
      tags: 'krmcbride/node:gallium-bullseye-dev,krmcbride/node:gallium-dev,krmcbride/node:16-dev'
  node_18-bullseye-base:
    <<: *defaults
    environment:
      context: ./build/node/18-bullseye-base
      image: 'krmcbride/node:18-bullseye-base'
      tags: 'krmcbride/node:gallium-bullseye-base,krmcbride/node:gallium-bullseye,krmcbride/node:gallium,krmcbride/node:18-bullseye,krmcbride/node:18'
  node_18-bullseye-dev:
    <<: *defaults
    environment:
      context: ./build/node/18-bullseye-dev
      image: 'krmcbride/node:18-bullseye-dev'
      tags: 'krmcbride/node:gallium-bullseye-dev,krmcbride/node:gallium-dev,krmcbride/node:18-dev'


workflows:
  version: 2
  build:
    jobs:
      - make

      - debian_stretch-base:
          filters: { branches: { only: [ master ] } }
          requires:
          - make
      - debian_stretch-dev:
          filters: { branches: { only: [ master ] } }
          requires:
          - debian_stretch-base
      - debian_buster-base:
          filters: { branches: { only: [ master ] } }
          requires:
          - make
      - debian_buster-dev:
          filters: { branches: { only: [ master ] } }
          requires:
          - debian_buster-base
      - debian_bullseye-base:
          filters: { branches: { only: [ master ] } }
          requires:
          - make
      - debian_bullseye-dev:
          filters: { branches: { only: [ master ] } }
          requires:
          - debian_bullseye-base

      - java_8-stretch-base:
          filters: { branches: { only: [ master ] } }
          requires:
          - make
      - java_8-stretch-dev:
          filters: { branches: { only: [ master ] } }
          requires:
          - java_8-stretch-base
      - corretto_8-amazonlinux2-base:
          filters: { branches: { only: [ master ] } }
          requires:
          - make

      - node_16-bullseye-base:
          filters: { branches: { only: [ master ] } }
          requires:
          - make
      - node_16-bullseye-dev:
          filters: { branches: { only: [ master ] } }
          requires:
          - node_16-bullseye-base
      - node_18-buster-base:
          filters: { branches: { only: [ master ] } }
          requires:
          - make
      - node_18-buster-dev:
          filters: { branches: { only: [ master ] } }
          requires:
          - node_18-bullseye-base

